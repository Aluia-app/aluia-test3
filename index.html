<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AluIA - Supporto Psicologico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 50%, #90CAF9 100%);
            min-height: 100vh;
            color: #1A237E;
            padding: 20px;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1E3A8A 0%, #1E40AF 100%);
            color: #E3F2FD;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .header {
            background: rgba(30, 58, 138, 0.95);
        }

        .header h1 {
            font-size: 3em;
            font-weight: 700;
            background: linear-gradient(135deg, #1976D2, #42A5F5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .dark-mode .header h1 {
            background: linear-gradient(135deg, #90CAF9, #E3F2FD);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #5C6BC0;
            font-size: 1.3em;
        }

        .dark-mode .header p {
            color: #BBDEFB;
        }

        .theme-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            background: rgba(25, 118, 210, 0.1);
            border: none;
            font-size: 28px;
            cursor: pointer;
            padding: 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(25, 118, 210, 0.2);
            transform: scale(1.1);
        }

        .audio-controls {
            position: absolute;
            top: 25px;
            left: 25px;
            display: flex;
            gap: 10px;
        }

        .audio-control-btn {
            background: rgba(25, 118, 210, 0.1);
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .audio-control-btn:hover {
            background: rgba(25, 118, 210, 0.2);
            transform: scale(1.05);
        }

        .audio-control-btn.active {
            background: rgba(76, 175, 80, 0.2);
        }

        .audio-control-btn.muted {
            background: rgba(244, 67, 54, 0.2);
        }

        @media (max-width: 768px) {
            .audio-controls {
                position: relative;
                top: auto;
                left: auto;
                justify-content: center;
                margin-bottom: 15px;
            }
        }

        .status-bar {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(15px);
            background: rgba(255, 152, 0, 0.9);
            color: white;
        }

        .status-bar.connected {
            background: rgba(76, 175, 80, 0.9);
        }

        .status-bar.error {
            background: rgba(244, 67, 54, 0.9);
        }

        .main-interface {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-interface {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 35px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .section {
            background: rgba(30, 58, 138, 0.95);
        }

        .section h2 {
            color: #1976D2;
            font-weight: 600;
            margin-bottom: 30px;
            text-align: center;
        }

        .dark-mode .section h2 {
            color: #90CAF9;
        }

        .mic-controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .mic-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #1976D2, #42A5F5);
            color: white;
            font-size: 3em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(25, 118, 210, 0.3);
        }

        .mic-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(25, 118, 210, 0.4);
        }

        .mic-button.active {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 25px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        .mic-button.speaking {
            background: linear-gradient(135deg, #FF9800, #FFB74D);
            animation: speaking 1s infinite;
        }

        @keyframes speaking {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .mic-status {
            margin-top: 20px;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            background: rgba(227, 242, 253, 0.9);
            color: #1976D2;
            border: 2px solid rgba(25, 118, 210, 0.3);
        }

        .mic-status.listening {
            background: rgba(232, 245, 233, 0.9);
            color: #388E3C;
            border-color: rgba(76, 175, 80, 0.3);
        }

        .mic-status.processing {
            background: rgba(255, 243, 224, 0.9);
            color: #F57C00;
            border-color: rgba(255, 152, 0, 0.3);
        }

        .mic-status.speaking {
            background: rgba(255, 243, 224, 0.9);
            color: #FF9800;
            border-color: rgba(255, 152, 0, 0.3);
        }

        .mic-status.error {
            background: rgba(255, 235, 238, 0.9);
            color: #D32F2F;
            border-color: rgba(244, 67, 54, 0.3);
        }

        /* Mic device selector */
        .mic-device-info {
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(227, 242, 253, 0.6);
            border-radius: 15px;
            font-size: 13px;
            color: #1976D2;
            display: none;
        }

        .mic-device-info.show {
            display: block;
        }

        .mic-device-selector {
            margin-top: 10px;
            padding: 8px 15px;
            border: 1px solid rgba(25, 118, 210, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #1976D2;
            font-size: 12px;
            cursor: pointer;
            width: 100%;
        }

        .dark-mode .mic-device-selector {
            background: rgba(30, 58, 138, 0.9);
            color: #E3F2FD;
            border-color: rgba(144, 202, 249, 0.3);
        }

        .transcription {
            background: rgba(227, 242, 253, 0.7);
            border: 2px dashed rgba(25, 118, 210, 0.3);
            border-radius: 20px;
            padding: 25px;
            min-height: 120px;
            font-style: italic;
            color: #1976D2;
            font-size: 15px;
            line-height: 1.6;
        }

        .dark-mode .transcription {
            background: rgba(30, 58, 138, 0.7);
            border-color: rgba(144, 202, 249, 0.3);
            color: #BBDEFB;
        }

        .chat-container {
            height: 400px;
            border: 2px solid rgba(25, 118, 210, 0.2);
            border-radius: 20px;
            overflow-y: auto;
            padding: 25px;
            margin-bottom: 20px;
            background: rgba(227, 242, 253, 0.5);
        }

        .dark-mode .chat-container {
            background: rgba(30, 58, 138, 0.5);
            border-color: rgba(144, 202, 249, 0.3);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.5;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: linear-gradient(135deg, #1976D2, #42A5F5);
            color: white;
            margin-left: auto;
            box-shadow: 0 4px 20px rgba(25, 118, 210, 0.3);
        }

        .message.assistant {
            background: rgba(255, 255, 255, 0.9);
            color: #1A237E;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(25, 118, 210, 0.1);
        }

        .dark-mode .message.assistant {
            background: rgba(30, 58, 138, 0.9);
            color: #E3F2FD;
            border: 1px solid rgba(144, 202, 249, 0.2);
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            max-width: 100px;
            margin-bottom: 20px;
        }

        .dark-mode .typing-indicator {
            background: rgba(30, 58, 138, 0.9);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #1976D2;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
            30% { transform: scale(1.3); opacity: 1; }
        }

        .input-area {
            display: flex;
            gap: 15px;
        }

        .chat-input {
            flex: 1;
            padding: 18px 25px;
            border: 2px solid rgba(25, 118, 210, 0.3);
            border-radius: 30px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .dark-mode .chat-input {
            background: rgba(30, 58, 138, 0.9);
            border-color: rgba(144, 202, 249, 0.3);
            color: #E3F2FD;
        }

        .chat-input:focus {
            border-color: #1976D2;
            box-shadow: 0 0 0 4px rgba(25, 118, 210, 0.1);
            transform: translateY(-2px);
        }

        .send-button {
            padding: 18px 30px;
            background: linear-gradient(135deg, #1976D2, #42A5F5);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.3);
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 25px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .dark-mode .controls {
            background: rgba(30, 58, 138, 0.95);
        }

        .control-button {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            min-width: 180px;
            transition: all 0.3s ease;
        }

        .control-button.admin {
            background: linear-gradient(135deg, #1976D2, #42A5F5);
            color: white;
            display: none;
        }

        .control-button.privacy {
            background: linear-gradient(135deg, #FF9800, #FFB74D);
            color: white;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(76, 175, 80, 0.95);
            color: white;
            padding: 18px 25px;
            border-radius: 15px;
            font-weight: 600;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.4s ease;
            z-index: 1001;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: rgba(244, 67, 54, 0.95);
        }

        .toast.warning {
            background: rgba(255, 152, 0, 0.95);
        }

        .emergency {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            border: 2px solid rgba(244, 67, 54, 0.2);
            margin-bottom: 30px;
        }

        .dark-mode .emergency {
            background: rgba(30, 58, 138, 0.95);
            border-color: rgba(255, 138, 128, 0.3);
        }

        .emergency h3 {
            color: #D32F2F;
            margin-bottom: 25px;
            font-size: 1.6em;
            font-weight: 700;
        }

        .country {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(244, 67, 54, 0.05);
            border-radius: 15px;
            border-left: 4px solid #D32F2F;
        }

        .dark-mode .country {
            background: rgba(244, 67, 54, 0.1);
        }

        .country-title {
            font-weight: 700;
            color: #D32F2F;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .emergency-link {
            color: #D32F2F;
            text-decoration: none;
            font-weight: 600;
            margin: 5px 8px;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .emergency-link:hover {
            background: rgba(244, 67, 54, 0.1);
            text-decoration: underline;
            transform: translateY(-1px);
        }

        .footer {
            text-align: center;
            color: #1976D2;
            padding: 30px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .dark-mode .footer {
            color: #BBDEFB;
            background: rgba(30, 58, 138, 0.8);
        }

        .disclaimer {
            font-weight: 700;
            margin-bottom: 15px;
            color: #D32F2F;
            font-size: 1.2em;
        }

        .dark-mode .disclaimer {
            color: #FF8A80;
        }

        .closing {
            background: rgba(25, 118, 210, 0.1);
            border: 2px solid rgba(25, 118, 210, 0.2);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            font-style: italic;
            color: #1976D2;
            font-weight: 600;
            font-size: 1.2em;
        }

        .dark-mode .closing {
            background: rgba(144, 202, 249, 0.1);
            color: #90CAF9;
            border-color: rgba(144, 202, 249, 0.3);
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">⚠️ Demo Mode</div>
    
    <div class="container">
        <div class="header">
            <div class="audio-controls">
                <button class="audio-control-btn" id="audioToggle" title="Toggle audio">🔊</button>
                <button class="audio-control-btn" id="volumeControl" title="Volume control">🎚️</button>
            </div>
            
            <button class="theme-toggle" id="themeToggle" title="Toggle theme">🌙</button>
            <h1>AluIA</h1>
            <p id="headerSubtitle">Intelligent psychological support always by your side</p>
        </div>

        <div class="main-interface">
            <div class="section">
                <h2 id="voiceTitle">🎤 Voice Communication</h2>
                
                <div class="mic-controls">
                    <button class="mic-button" id="micBtn">🎤</button>
                    <div class="mic-status" id="micStatus">Click to activate microphone</div>
                    <div class="mic-device-info" id="micDeviceInfo">
                        <div id="selectedDevice">Device: Detecting...</div>
                        <select class="mic-device-selector" id="micDeviceSelector">
                            <option value="">Select microphone...</option>
                        </select>
                    </div>
                </div>

                <div class="transcription" id="transcription">
                    Real-time transcription will appear here...
                </div>
            </div>

            <div class="section">
                <h2 id="chatTitle">💬 Chat with Alu</h2>
                
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant" id="welcomeMessage">
                        👋 Hello! I'm Alu and I'm here to help you. You can talk to me vocally by pressing the microphone or write here in the chat. How can I support you today?
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>

                <div class="input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Write your message...">
                    <button class="send-button" id="sendBtn">Send</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="control-button admin" id="adminBtn">⚙️ Admin Config</button>
            <button class="control-button privacy" id="privacyBtn">🔒 Privacy & Security</button>
        </div>

        <div class="emergency" id="emergencySection">
            <h3 id="emergencyTitle">🆘 EMERGENCY CONTACTS</h3>
            <div id="emergencyCountries">
                <!-- Emergency contacts will be populated by JavaScript based on language -->
            </div>
        </div>

        <div class="footer">
            <div class="disclaimer" id="disclaimerText">
                ⚠️ IMPORTANT: AluIA does not replace professional psychological support.
            </div>
            <p id="footerText1">In case of emergencies, immediately contact a qualified professional or emergency services.</p>
            <p style="margin-top: 15px; font-size: 0.9em;" id="footerText2">
                🔒 <strong>Guaranteed Privacy:</strong> All conversations are completely private and secure. 
                Your data is never shared or saved on our servers.
            </p>
        </div>

        <div class="closing" id="closingMessage">
            💙 "Whenever you want, I'm here to always listen to you." - Alu
        </div>
    </div>

    <!-- Admin Config Modal -->
    <div id="adminModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px);">
        <div style="background: white; margin: 5% auto; padding: 40px; border-radius: 24px; width: 90%; max-width: 600px; position: relative; animation: modalAppear 0.4s ease;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid rgba(25, 118, 210, 0.1);">
                <h2 style="font-size: 1.6em; font-weight: 700; color: #1976D2;" id="adminModalTitle">⚙️ Administrator Configuration</h2>
                <button id="closeAdmin" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #757575;">&times;</button>
            </div>
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #1976D2;" id="apiKeyLabel">OpenAI API Key:</label>
                <input type="password" id="apiKey" placeholder="sk-..." style="width: 100%; padding: 15px 20px; border: 2px solid rgba(25, 118, 210, 0.3); border-radius: 15px; font-size: 16px;">
            </div>
            <div style="margin-bottom: 25px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #1976D2;" id="assistantIdLabel">Assistant ID (optional):</label>
                <input type="text" id="assistantId" placeholder="asst_..." style="width: 100%; padding: 15px 20px; border: 2px solid rgba(25, 118, 210, 0.3); border-radius: 15px; font-size: 16px;">
            </div>
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                <button id="cancelAdmin" style="padding: 15px 30px; border: none; border-radius: 15px; cursor: pointer; font-weight: 600; font-size: 15px; background: rgba(189, 189, 189, 0.2); color: #1976D2; border: 2px solid rgba(25, 118, 210, 0.3);">Cancel</button>
                <button id="saveAdmin" style="padding: 15px 30px; border: none; border-radius: 15px; cursor: pointer; font-weight: 600; font-size: 15px; background: linear-gradient(135deg, #1976D2, #42A5F5); color: white;">Save</button>
            </div>
        </div>
    </div>

    <script>
        console.log('🚀 Starting AluIA Multilingual + Smart Microphone...');

        // === MULTILINGUAL SYSTEM ===
        const translations = {
            it: {
                lang: 'it-IT',
                title: 'AluIA - Supporto Psicologico',
                headerSubtitle: 'Supporto psicologico intelligente sempre al tuo fianco',
                voiceTitle: '🎤 Comunicazione Vocale',
                chatTitle: '💬 Chat con Alu',
                welcomeMessage: '👋 Ciao! Sono Alu e sono qui per aiutarti. Puoi parlarmi vocalmente premendo il microfono o scrivere qui nella chat. Come posso supportarti oggi?',
                micClickToActivate: 'Clicca per attivare il microfono',
                micInitializing: '⚡ Inizializzazione microfono...',
                micActive: '🎧 Microfono attivo - Parla liberamente!',
                micSpeaking: '🗣️ Alu sta parlando...',
                micError: '❌ Errore microfono - Clicca per riprovare',
                micDisabled: '🚫 Microfono disabilitato',
                transcriptionPlaceholder: 'La trascrizione in tempo reale apparirà qui...',
                chatPlaceholder: 'Scrivi il tuo messaggio...',
                sendButton: 'Invia',
                privacyButton: '🔒 Privacy e Sicurezza',
                emergencyTitle: '🆘 CONTATTI DI EMERGENZA',
                disclaimerText: '⚠️ IMPORTANTE: AluIA non sostituisce il supporto psicologico professionale.',
                footerText1: 'In caso di emergenze, contatta immediatamente un professionista qualificato o i servizi di emergenza.',
                footerText2: '🔒 <strong>Privacy Garantita:</strong> Tutte le conversazioni sono completamente private e sicure. I tuoi dati non vengono mai condivisi o salvati sui nostri server.',
                closingMessage: '💙 "Quando vuoi, sono qui per ascoltarti sempre." - Alu',
                statusDemo: '⚠️ Modalità Demo',
                statusReady: '✅ Alu Pronta',
                deviceBuiltIn: '🖥️ Microfono integrato',
                deviceHeadset: '🎧 Auricolari/Cuffie',
                deviceExternal: '🎤 Microfono esterno',
                deviceUnknown: '❓ Dispositivo sconosciuto',
                selectMicrophone: 'Seleziona microfono...',
                adminModalTitle: '⚙️ Configurazione Amministratore',
                apiKeyLabel: 'OpenAI API Key:',
                assistantIdLabel: 'Assistant ID (opzionale):',
                cancelButton: 'Annulla',
                saveButton: 'Salva',
                systemPrompt: 'Sei Alu, un assistente di supporto psicologico empatico e professionale di AluIA. Fornisci supporto emotivo, ascolto attivo e consigli pratici. Rispondi sempre in italiano. Sii caloroso, comprensivo e rassicurante. Ricorda che non sostituisci un professionista della salute mentale e in caso di emergenze suggerisci di contattare i servizi appropriati. Concludi sempre con incoraggiamento.',
                emergencyContacts: {
                    'Italia': {
                        flag: '🇮🇹',
                        contacts: [
                            { name: 'Telefono Amico', number: '800833833', desc: '📞 Telefono Amico: 800.833.833' },
                            { name: 'Dall\'estero', number: '+39022022873', desc: '🌍 Dall\'estero: +39 02 20228733' },
                            { name: 'Emergenza', number: '112', desc: '🚨 Numero Unico Emergenza: 112' },
                            { name: 'Antiviolenza', number: '1522', desc: '🛡️ Antiviolenza e Stalking: 1522' },
                            { name: 'Croce Rossa', number: '1520', desc: '❤️ Croce Rossa Emergenza Psicologica: 1520' }
                        ]
                    }
                }
            },
            en: {
                lang: 'en-US',
                title: 'AluIA - Psychological Support',
                headerSubtitle: 'Intelligent psychological support always by your side',
                voiceTitle: '🎤 Voice Communication',
                chatTitle: '💬 Chat with Alu',
                welcomeMessage: '👋 Hello! I\'m Alu and I\'m here to help you. You can talk to me vocally by pressing the microphone or write here in the chat. How can I support you today?',
                micClickToActivate: 'Click to activate microphone',
                micInitializing: '⚡ Initializing microphone...',
                micActive: '🎧 Microphone active - Speak freely!',
                micSpeaking: '🗣️ Alu is speaking...',
                micError: '❌ Microphone error - Click to retry',
                micDisabled: '🚫 Microphone disabled',
                transcriptionPlaceholder: 'Real-time transcription will appear here...',
                chatPlaceholder: 'Write your message...',
                sendButton: 'Send',
                privacyButton: '🔒 Privacy & Security',
                emergencyTitle: '🆘 EMERGENCY CONTACTS',
                disclaimerText: '⚠️ IMPORTANT: AluIA does not replace professional psychological support.',
                footerText1: 'In case of emergencies, immediately contact a qualified professional or emergency services.',
                footerText2: '🔒 <strong>Guaranteed Privacy:</strong> All conversations are completely private and secure. Your data is never shared or saved on our servers.',
                closingMessage: '💙 "Whenever you want, I\'m here to always listen to you." - Alu',
                statusDemo: '⚠️ Demo Mode',
                statusReady: '✅ Alu Ready',
                deviceBuiltIn: '🖥️ Built-in microphone',
                deviceHeadset: '🎧 Headphones/Headset',
                deviceExternal: '🎤 External microphone',
                deviceUnknown: '❓ Unknown device',
                selectMicrophone: 'Select microphone...',
                adminModalTitle: '⚙️ Administrator Configuration',
                apiKeyLabel: 'OpenAI API Key:',
                assistantIdLabel: 'Assistant ID (optional):',
                cancelButton: 'Cancel',
                saveButton: 'Save',
                systemPrompt: 'You are Alu, an empathetic and professional psychological support assistant from AluIA. Provide emotional support, active listening and practical advice. Always respond in English. Be warm, understanding and reassuring. Remember that you do not replace a mental health professional and in case of emergencies suggest contacting appropriate services. Always end with encouragement.',
                emergencyContacts: {
                    'United Kingdom': {
                        flag: '🇬🇧',
                        contacts: [
                            { name: 'Emergency', number: '999', desc: '🚨 Emergencies: 999' },
                            { name: 'Domestic Abuse', number: '08082000247', desc: '🛡️ Domestic Abuse Helpline: 0808 2000 247' },
                            { name: 'Samaritans', number: '116123', desc: '💙 Samaritans: 116 123' },
                            { name: 'Childline', number: '08001111', desc: '👶 Childline: 0800 1111' }
                        ]
                    },
                    'United States': {
                        flag: '🇺🇸',
                        contacts: [
                            { name: 'Emergency', number: '911', desc: '🚨 Emergency: 911' },
                            { name: 'Suicide Prevention', number: '988', desc: '💙 Suicide & Crisis Lifeline: 988' },
                            { name: 'Crisis Text', number: '741741', desc: '📱 Crisis Text Line: Text HOME to 741741' }
                        ]
                    }
                }
            },
            pt: {
                lang: 'pt-PT',
                title: 'AluIA - Apoio Psicológico',
                headerSubtitle: 'Apoio psicológico inteligente sempre ao seu lado',
                voiceTitle: '🎤 Comunicação por Voz',
                chatTitle: '💬 Chat com Alu',
                welcomeMessage: '👋 Olá! Sou a Alu e estou aqui para ajudar. Pode falar comigo vocalmente premindo o microfone ou escrever aqui no chat. Como posso apoiá-lo hoje?',
                micClickToActivate: 'Clique para ativar o microfone',
                micInitializing: '⚡ Inicializando microfone...',
                micActive: '🎧 Microfone ativo - Fale livremente!',
                micSpeaking: '🗣️ Alu está a falar...',
                micError: '❌ Erro no microfone - Clique para tentar novamente',
                micDisabled: '🚫 Microfone desativado',
                transcriptionPlaceholder: 'A transcrição em tempo real aparecerá aqui...',
                chatPlaceholder: 'Escreva a sua mensagem...',
                sendButton: 'Enviar',
                privacyButton: '🔒 Privacidade e Segurança',
                emergencyTitle: '🆘 CONTACTOS DE EMERGÊNCIA',
                disclaimerText: '⚠️ IMPORTANTE: AluIA não substitui o apoio psicológico profissional.',
                footerText1: 'Em caso de emergências, contacte imediatamente um profissional qualificado ou os serviços de emergência.',
                footerText2: '🔒 <strong>Privacidade Garantida:</strong> Todas as conversas são completamente privadas e seguras. Os seus dados nunca são partilhados ou guardados nos nossos servidores.',
                closingMessage: '💙 "Quando quiser, estou aqui para a escutar sempre." - Alu',
                statusDemo: '⚠️ Modo Demo',
                statusReady: '✅ Alu Pronta',
                deviceBuiltIn: '🖥️ Microfone integrado',
                deviceHeadset: '🎧 Auscultadores/Headset',
                deviceExternal: '🎤 Microfone externo',
                deviceUnknown: '❓ Dispositivo desconhecido',
                selectMicrophone: 'Selecionar microfone...',
                adminModalTitle: '⚙️ Configuração do Administrador',
                apiKeyLabel: 'OpenAI API Key:',
                assistantIdLabel: 'Assistant ID (opcional):',
                cancelButton: 'Cancelar',
                saveButton: 'Guardar',
                systemPrompt: 'És a Alu, uma assistente de apoio psicológico empática e profissional da AluIA. Fornece apoio emocional, escuta ativa e conselhos práticos. Responde sempre em português. Sê calorosa, compreensiva e tranquilizadora. Lembra-te que não substituis um profissional de saúde mental e em caso de emergências sugere contactar os serviços apropriados. Termina sempre com encorajamento.',
                emergencyContacts: {
                    'Portugal': {
                        flag: '🇵🇹',
                        contacts: [
                            { name: 'SNS 24', number: '808242424', desc: '🏥 SNS 24: 808 24 24 24 (opção 4)' },
                            { name: 'APAV', number: '116006', desc: '🆘 APAV: 116 006' },
                            { name: 'Emergência', number: '112', desc: '🚨 Emergência UE: 112' },
                            { name: 'SOS Voz Amiga', number: '213544545', desc: '💚 SOS Voz Amiga: 213 544 545' },
                            { name: 'Conversa Amiga', number: '925512884', desc: '🤝 Conversa Amiga: 925 512 884' }
                        ]
                    }
                }
            },
            es: {
                lang: 'es-ES',
                title: 'AluIA - Apoyo Psicológico',
                headerSubtitle: 'Apoyo psicológico inteligente siempre a tu lado',
                voiceTitle: '🎤 Comunicación por Voz',
                chatTitle: '💬 Chat con Alu',
                welcomeMessage: '👋 ¡Hola! Soy Alu y estoy aquí para ayudarte. Puedes hablarme vocalmente presionando el micrófono o escribir aquí en el chat. ¿Cómo puedo apoyarte hoy?',
                micClickToActivate: 'Haz clic para activar el micrófono',
                micInitializing: '⚡ Inicializando micrófono...',
                micActive: '🎧 Micrófono activo - ¡Habla libremente!',
                micSpeaking: '🗣️ Alu está hablando...',
                micError: '❌ Error de micrófono - Haz clic para reintentar',
                micDisabled: '🚫 Micrófono desactivado',
                transcriptionPlaceholder: 'La transcripción en tiempo real aparecerá aquí...',
                chatPlaceholder: 'Escribe tu mensaje...',
                sendButton: 'Enviar',
                privacyButton: '🔒 Privacidad y Seguridad',
                emergencyTitle: '🆘 CONTACTOS DE EMERGENCIA',
                disclaimerText: '⚠️ IMPORTANTE: AluIA no sustituye el apoyo psicológico profesional.',
                footerText1: 'En caso de emergencias, contacta inmediatamente a un profesional cualificado o a los servicios de emergencia.',
                footerText2: '🔒 <strong>Privacidad Garantizada:</strong> Todas las conversaciones son completamente privadas y seguras. Tus datos nunca se comparten o guardan en nuestros servidores.',
                closingMessage: '💙 "Cuando quieras, estoy aquí para escucharte siempre." - Alu',
                statusDemo: '⚠️ Modo Demo',
                statusReady: '✅ Alu Lista',
                deviceBuiltIn: '🖥️ Micrófono integrado',
                deviceHeadset: '🎧 Auriculares/Cascos',
                deviceExternal: '🎤 Micrófono externo',
                deviceUnknown: '❓ Dispositivo desconocido',
                selectMicrophone: 'Seleccionar micrófono...',
                adminModalTitle: '⚙️ Configuración del Administrador',
                apiKeyLabel: 'OpenAI API Key:',
                assistantIdLabel: 'Assistant ID (opcional):',
                cancelButton: 'Cancelar',
                saveButton: 'Guardar',
                systemPrompt: 'Eres Alu, una asistente de apoyo psicológico empática y profesional de AluIA. Proporciona apoyo emocional, escucha activa y consejos prácticos. Responde siempre en español. Sé cálida, comprensiva y tranquilizadora. Recuerda que no sustituyes a un profesional de la salud mental y en caso de emergencias sugiere contactar los servicios apropiados. Termina siempre con aliento.',
                emergencyContacts: {
                    'España': {
                        flag: '🇪🇸',
                        contacts: [
                            { name: 'Emergencia', number: '112', desc: '🚨 Emergencia General: 112' },
                            { name: 'Apoyo Psicológico', number: '800101800', desc: '🧠 Apoyo Psicológico 24h: 800 101 800' },
                            { name: 'Violencia de Género', number: '016', desc: '🛡️ Violencia de Género: 016' },
                            { name: 'Teléfono de la Esperanza', number: '717003717', desc: '💚 Teléfono de la Esperanza: 717 003 717' }
                        ]
                    }
                }
            }
        };

        class AluIA {
            constructor() {
                // === LANGUAGE SYSTEM ===
                this.detectedLanguage = this.detectLanguage();
                this.currentLang = translations[this.detectedLanguage] || translations.en;
                
                // === CORE STATES ===
                this.micState = 'IDLE';
                this.recognition = null;
                this.isProcessing = false;
                this.isDarkMode = localStorage.getItem('aluia_theme') === 'dark';
                this.conversationHistory = [];
                
                // === API CONFIGURATION ===
                this.apiKey = localStorage.getItem('aluia_api_key') || '';
                this.isApiConfigured = this.apiKey.length > 0;
                
                // === MICROPHONE DEVICE MANAGEMENT ===
                this.availableDevices = [];
                this.selectedDeviceId = localStorage.getItem('aluia_selected_device') || '';
                this.deviceType = 'unknown';
                
                // === ERROR MANAGEMENT ===
                this.errorCount = 0;
                this.maxErrors = 3;
                this.lastErrorTime = 0;
                this.errorResetInterval = 60000;
                
                // === AUDIO ELEVENLABS ===
                this.audioEnabled = localStorage.getItem('aluia_audio_enabled') !== 'false';
                this.audioVolume = parseFloat(localStorage.getItem('aluia_audio_volume')) || 0.8;
                this.currentAudio = null;
                this.isPlayingAudio = false;
                this.elevenLabsVoiceId = 'IyWqvgbFwm4IK1x6M489';
                
                // === TIMERS ===
                this.stateTimeout = null;
                this.healthCheckInterval = null;
                
                // === INITIALIZATION ===
                this.initLanguage();
                this.initElements();
                this.setupEvents();
                this.applyTheme();
                this.updateUI();
                this.initAudioControls();
                this.initMicrophoneDevices();
                this.startHealthCheck();
                
                console.log('✅ AluIA Multilingual + Smart Microphone initialized');
                console.log('🌍 Detected language:', this.detectedLanguage);
                this.showToast(this.currentLang.micClickToActivate, 'success');
            }

            // === LANGUAGE DETECTION & INITIALIZATION ===

            detectLanguage() {
                // Priority: URL parameter > referrer > browser language > default
                const urlParams = new URLSearchParams(window.location.search);
                const urlLang = urlParams.get('lang');
                
                if (urlLang && translations[urlLang]) {
                    console.log('🌍 Language from URL:', urlLang);
                    return urlLang;
                }
                
                // Check referrer language
                const referrer = document.referrer;
                if (referrer) {
                    try {
                        const referrerUrl = new URL(referrer);
                        const referrerDomain = referrerUrl.hostname.toLowerCase();
                        
                        if (referrerDomain.includes('.it') || referrerDomain.includes('italia')) {
                            console.log('🌍 Language from referrer domain (IT):', referrerDomain);
                            return 'it';
                        } else if (referrerDomain.includes('.pt') || referrerDomain.includes('portugal')) {
                            console.log('🌍 Language from referrer domain (PT):', referrerDomain);
                            return 'pt';
                        } else if (referrerDomain.includes('.es') || referrerDomain.includes('españa') || referrerDomain.includes('spain')) {
                            console.log('🌍 Language from referrer domain (ES):', referrerDomain);
                            return 'es';
                        }
                    } catch (e) {
                        console.warn('⚠️ Could not parse referrer URL:', e);
                    }
                }
                
                // Browser language
                const browserLang = navigator.language || navigator.userLanguage || 'en';
                const langCode = browserLang.split('-')[0];
                
                if (translations[langCode]) {
                    console.log('🌍 Language from browser:', langCode);
                    return langCode;
                }
                
                console.log('🌍 Using default language: en');
                return 'en';
            }

            initLanguage() {
                // Set document language and title
                document.documentElement.lang = this.detectedLanguage;
                document.title = this.currentLang.title;
                
                // Update all text elements
                this.updateAllTexts();
                this.buildEmergencyContacts();
                
                console.log('🌍 Language system initialized for:', this.detectedLanguage);
            }

            updateAllTexts() {
                const elements = {
                    'headerSubtitle': this.currentLang.headerSubtitle,
                    'voiceTitle': this.currentLang.voiceTitle,
                    'chatTitle': this.currentLang.chatTitle,
                    'welcomeMessage': this.currentLang.welcomeMessage,
                    'transcription': this.currentLang.transcriptionPlaceholder,
                    'chatInput': this.currentLang.chatPlaceholder,
                    'sendBtn': this.currentLang.sendButton,
                    'privacyBtn': this.currentLang.privacyButton,
                    'emergencyTitle': this.currentLang.emergencyTitle,
                    'disclaimerText': this.currentLang.disclaimerText,
                    'footerText1': this.currentLang.footerText1,
                    'closingMessage': this.currentLang.closingMessage,
                    'adminModalTitle': this.currentLang.adminModalTitle,
                    'apiKeyLabel': this.currentLang.apiKeyLabel,
                    'assistantIdLabel': this.currentLang.assistantIdLabel
                };

                for (const [id, text] of Object.entries(elements)) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.tagName === 'INPUT') {
                            element.placeholder = text;
                        } else {
                            element.textContent = text;
                        }
                    }
                }

                // Special handling for HTML content
                const footerText2 = document.getElementById('footerText2');
                if (footerText2) {
                    footerText2.innerHTML = this.currentLang.footerText2;
                }

                // Update buttons
                const cancelAdmin = document.getElementById('cancelAdmin');
                const saveAdmin = document.getElementById('saveAdmin');
                if (cancelAdmin) cancelAdmin.textContent = this.currentLang.cancelButton;
                if (saveAdmin) saveAdmin.textContent = this.currentLang.saveButton;
            }

            buildEmergencyContacts() {
                const container = document.getElementById('emergencyCountries');
                if (!container) return;

                container.innerHTML = '';

                Object.entries(this.currentLang.emergencyContacts).forEach(([country, data]) => {
                    const countryDiv = document.createElement('div');
                    countryDiv.className = 'country';
                    
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'country-title';
                    titleDiv.textContent = `${data.flag} ${country.toUpperCase()}`;
                    countryDiv.appendChild(titleDiv);

                    data.contacts.forEach(contact => {
                        const link = document.createElement('a');
                        link.href = `tel:${contact.number}`;
                        link.className = 'emergency-link';
                        link.textContent = contact.desc;
                        countryDiv.appendChild(link);
                    });

                    container.appendChild(countryDiv);
                });
            }

            // === MICROPHONE DEVICE MANAGEMENT ===

            async initMicrophoneDevices() {
                try {
                    console.log('🎤 Initializing microphone device detection...');
                    
                    // Request permissions first
                    await navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            stream.getTracks().forEach(track => track.stop());
                        });
                    
                    await this.detectAvailableDevices();
                    this.setupDeviceSelector();
                    
                } catch (error) {
                    console.error('❌ Error initializing microphone devices:', error);
                    this.showToast('Microphone permission required', 'error');
                }
            }

            async detectAvailableDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.availableDevices = devices.filter(device => device.kind === 'audioinput');
                    
                    console.log('🎤 Found audio input devices:', this.availableDevices.length);
                    
                    // Auto-select best device if none selected
                    if (!this.selectedDeviceId && this.availableDevices.length > 0) {
                        this.selectedDeviceId = this.selectBestDevice();
                        localStorage.setItem('aluia_selected_device', this.selectedDeviceId);
                    }
                    
                    this.updateDeviceInfo();
                    
                } catch (error) {
                    console.error('❌ Error detecting devices:', error);
                }
            }

            selectBestDevice() {
                if (this.availableDevices.length === 0) return '';
                
                // Priority order: external mic > headset > built-in
                const priorities = [
                    device => this.classifyDevice(device.label) === 'external',
                    device => this.classifyDevice(device.label) === 'headset',
                    device => this.classifyDevice(device.label) === 'built-in'
                ];
                
                for (const priorityFn of priorities) {
                    const device = this.availableDevices.find(priorityFn);
                    if (device) {
                        console.log('🎤 Auto-selected device:', device.label);
                        return device.deviceId;
                    }
                }
                
                // Fallback to first device
                console.log('🎤 Using fallback device:', this.availableDevices[0].label);
                return this.availableDevices[0].deviceId;
            }

            classifyDevice(label) {
                const labelLower = label.toLowerCase();
                
                if (labelLower.includes('airpods') || 
                    labelLower.includes('headphone') || 
                    labelLower.includes('headset') ||
                    labelLower.includes('bluetooth') ||
                    labelLower.includes('wireless')) {
                    return 'headset';
                }
                
                if (labelLower.includes('usb') || 
                    labelLower.includes('external') ||
                    labelLower.includes('microphone') ||
                    labelLower.includes('blue') ||
                    labelLower.includes('rode') ||
                    labelLower.includes('audio-technica')) {
                    return 'external';
                }
                
                if (labelLower.includes('built-in') || 
                    labelLower.includes('internal') ||
                    labelLower.includes('default') ||
                    labelLower.includes('macbook') ||
                    labelLower.includes('laptop')) {
                    return 'built-in';
                }
                
                return 'unknown';
            }

            setupDeviceSelector() {
                const selector = document.getElementById('micDeviceSelector');
                if (!selector) return;
                
                // Clear existing options
                selector.innerHTML = `<option value="">${this.currentLang.selectMicrophone}</option>`;
                
                // Add device options
                this.availableDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = this.formatDeviceName(device.label);
                    if (device.deviceId === this.selectedDeviceId) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
                
                // Add change event listener
                selector.addEventListener('change', (e) => {
                    this.selectedDeviceId = e.target.value;
                    localStorage.setItem('aluia_selected_device', this.selectedDeviceId);
                    this.updateDeviceInfo();
                    
                    // Restart microphone if active
                    if (this.micState === 'ACTIVE') {
                        this.stopMicrophone();
                        setTimeout(() => this.startMicrophone(), 1000);
                    }
                });
                
                console.log('🎤 Device selector configured');
            }

            formatDeviceName(label) {
                if (!label || label === 'Default') return this.currentLang.deviceUnknown;
                
                const deviceType = this.classifyDevice(label);
                const typeIcon = {
                    'built-in': '🖥️',
                    'headset': '🎧',
                    'external': '🎤',
                    'unknown': '❓'
                }[deviceType];
                
                // Truncate long names
                let name = label;
                if (name.length > 25) {
                    name = name.substring(0, 22) + '...';
                }
                
                return `${typeIcon} ${name}`;
            }

            updateDeviceInfo() {
                const deviceInfo = document.getElementById('micDeviceInfo');
                const selectedDevice = document.getElementById('selectedDevice');
                
                if (!deviceInfo || !selectedDevice) return;
                
                const device = this.availableDevices.find(d => d.deviceId === this.selectedDeviceId);
                
                if (device) {
                    this.deviceType = this.classifyDevice(device.label);
                    const deviceName = this.formatDeviceName(device.label);
                    selectedDevice.textContent = `Device: ${deviceName}`;
                    deviceInfo.classList.add('show');
                } else {
                    selectedDevice.textContent = 'Device: ' + this.currentLang.deviceUnknown;
                    deviceInfo.classList.remove('show');
                }
                
                console.log('🎤 Device info updated:', this.deviceType);
            }

            // === CORE INITIALIZATION ===

            initElements() {
                this.micBtn = document.getElementById('micBtn');
                this.micStatus = document.getElementById('micStatus');
                this.transcription = document.getElementById('transcription');
                this.chatContainer = document.getElementById('chatContainer');
                this.chatInput = document.getElementById('chatInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.statusBar = document.getElementById('statusBar');
                this.themeToggle = document.getElementById('themeToggle');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.audioToggle = document.getElementById('audioToggle');
                this.volumeControl = document.getElementById('volumeControl');
                this.adminBtn = document.getElementById('adminBtn');
                this.privacyBtn = document.getElementById('privacyBtn');
                this.adminModal = document.getElementById('adminModal');

                console.log('📋 DOM elements initialized');
            }

            setupEvents() {
                // Microphone
                if (this.micBtn) {
                    this.micBtn.addEventListener('click', () => this.toggleMicrophone());
                }

                // Chat
                if (this.sendBtn) {
                    this.sendBtn.addEventListener('click', () => this.sendMessage());
                }

                if (this.chatInput) {
                    this.chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                }

                // Audio controls
                if (this.audioToggle) {
                    this.audioToggle.addEventListener('click', () => this.toggleAudio());
                }

                if (this.volumeControl) {
                    this.volumeControl.addEventListener('click', () => this.cycleVolume());
                }

                // Theme
                if (this.themeToggle) {
                    this.themeToggle.addEventListener('click', () => this.toggleTheme());
                }

                // Modals
                if (this.privacyBtn) {
                    this.privacyBtn.addEventListener('click', () => this.showPrivacyInfo());
                }

                if (this.adminBtn) {
                    this.adminBtn.addEventListener('click', () => this.showAdminModal());
                }

                // Admin modal events
                document.getElementById('closeAdmin')?.addEventListener('click', () => this.hideAdminModal());
                document.getElementById('cancelAdmin')?.addEventListener('click', () => this.hideAdminModal());
                document.getElementById('saveAdmin')?.addEventListener('click', () => this.saveAdminConfig());

                // Admin access
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                        const code = prompt('Administrator code:');
                        if (code === 'ALUIA2025') {
                            this.adminBtn.style.display = 'block';
                            this.showToast('Administrator access activated', 'success');
                        } else if (code !== null) {
                            this.showToast('Invalid code', 'error');
                        }
                    }
                });

                console.log('✅ Events configured');
            }

            // === MICROPHONE MANAGEMENT ===

            async toggleMicrophone() {
                console.log('🎤 Toggle microphone - current state:', this.micState);
                
                if (this.micState === 'ACTIVE') {
                    this.stopMicrophone();
                } else if (this.micState === 'IDLE' || this.micState === 'ERROR') {
                    await this.startMicrophone();
                } else {
                    console.log('⚠️ Microphone in transitional state:', this.micState);
                    this.showToast('Wait for microphone to be ready', 'warning');
                }
            }

            async startMicrophone() {
                if (this.micState !== 'IDLE' && this.micState !== 'ERROR') {
                    return;
                }

                this.setState('INITIALIZING');
                this.updateUI();

                try {
                    if (!this.checkSpeechRecognitionSupport()) {
                        throw new Error('Speech Recognition not supported');
                    }

                    console.log('🎤 Requesting microphone permissions...');
                    
                    // Use selected device
                    const constraints = { 
                        audio: this.selectedDeviceId ? 
                            { deviceId: { exact: this.selectedDeviceId } } : 
                            true 
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('✅ Microphone permissions granted');
                    
                    stream.getTracks().forEach(track => track.stop());

                    this.initSpeechRecognition();

                    console.log('🎤 Starting speech recognition...');
                    this.recognition.start();

                    this.stateTimeout = setTimeout(() => {
                        if (this.micState === 'INITIALIZING') {
                            console.log('⏰ Microphone start timeout');
                            this.handleMicrophoneError('Microphone start timeout');
                        }
                    }, 5000);

                } catch (error) {
                    console.error('❌ Microphone start error:', error);
                    this.handleMicrophoneError(error.message);
                }
            }

            stopMicrophone() {
                console.log('🔇 Stopping microphone...');
                
                this.clearTimeouts();
                
                if (this.recognition) {
                    try {
                        this.recognition.stop();
                        this.recognition.abort();
                        console.log('🔇 Recognition stopped');
                    } catch (e) {
                        console.warn('⚠️ Error stopping recognition:', e);
                    }
                }

                this.setState('IDLE');
                this.updateUI();
                this.showToast('Microphone deactivated', 'success');
            }

            checkSpeechRecognitionSupport() {
                const hasSupport = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
                console.log('🎤 Speech Recognition support:', hasSupport);
                
                if (!hasSupport) {
                    this.showToast('Use Chrome, Edge or Safari for voice recognition', 'error');
                }
                
                return hasSupport;
            }

            initSpeechRecognition() {
                if (this.recognition) {
                    this.recognition = null;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = this.currentLang.lang;
                this.recognition.maxAlternatives = 1;

                this.recognition.onstart = () => this.handleRecognitionStart();
                this.recognition.onresult = (event) => this.handleRecognitionResult(event);
                this.recognition.onend = () => this.handleRecognitionEnd();
                this.recognition.onerror = (event) => this.handleRecognitionError(event);

                console.log('✅ Speech Recognition configured for', this.currentLang.lang);
            }

            handleRecognitionStart() {
                console.log('🎤 Recognition started successfully');
                this.clearTimeouts();
                this.setState('ACTIVE');
                this.updateUI();
                this.resetErrorCount();
            }

            handleRecognitionResult(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                this.transcription.innerHTML = finalTranscript + 
                    '<span style="color: #90CAF9; opacity: 0.8;">' + interimTranscript + '</span>';

                if (finalTranscript.trim() && !this.isProcessing) {
                    console.log('🗣️ Final transcription:', finalTranscript.trim());
                    this.processVoiceInput(finalTranscript.trim());
                }
            }

            handleRecognitionEnd() {
                console.log('🔇 Recognition ended');
                
                if (this.micState === 'ACTIVE' && !this.isPlayingAudio) {
                    console.log('🔄 Attempting automatic restart...');
                    this.restartRecognition();
                } else {
                    this.setState('IDLE');
                    this.updateUI();
                }
            }

            handleRecognitionError(event) {
                console.error('❌ Recognition error:', event.error);
                
                switch(event.error) {
                    case 'not-allowed':
                        this.handleMicrophoneError('Microphone permission denied. Grant permissions and try again.');
                        this.setState('DISABLED');
                        break;
                    case 'no-speech':
                        console.log('⏸️ No speech detected, continuing...');
                        return;
                    case 'audio-capture':
                        this.handleMicrophoneError('No microphone found. Check that it is connected.');
                        this.setState('DISABLED');
                        break;
                    case 'network':
                        this.handleMicrophoneError('Network error. Check internet connection.');
                        break;
                    case 'aborted':
                        console.log('⚠️ Recognition interrupted');
                        if (this.micState === 'ACTIVE') {
                            this.restartRecognition();
                        }
                        return;
                    default:
                        this.handleMicrophoneError(`Technical error: ${event.error}`);
                        break;
                }
            }

            restartRecognition() {
                if (this.micState !== 'ACTIVE') return;

                console.log('🔄 Restarting recognition...');
                
                this.stateTimeout = setTimeout(() => {
                    if (this.micState === 'ACTIVE' && this.recognition && !this.isPlayingAudio) {
                        try {
                            this.recognition.start();
                            console.log('✅ Recognition restarted');
                        } catch (error) {
                            console.error('❌ Restart error:', error);
                            this.handleMicrophoneError('Microphone restart error');
                        }
                    }
                }, 1000);
            }

            handleMicrophoneError(errorMessage) {
                console.error('💥 Microphone error:', errorMessage);
                
                this.incrementErrorCount();
                
                if (this.errorCount >= this.maxErrors) {
                    console.log('🛑 Too many errors, disabling microphone');
                    this.setState('DISABLED');
                    this.showToast('Microphone disabled due to too many errors. Reload the page.', 'error');
                } else {
                    this.setState('ERROR');
                    this.showToast(errorMessage, 'error');
                }
                
                this.updateUI();
            }

            // === STATE MANAGEMENT ===

            setState(newState) {
                console.log(`🔄 State change: ${this.micState} → ${newState}`);
                this.micState = newState;
            }

            updateUI() {
                if (!this.micBtn || !this.micStatus) return;

                this.micBtn.className = 'mic-button';
                this.micStatus.className = 'mic-status';

                switch (this.micState) {
                    case 'IDLE':
                        this.micStatus.textContent = this.currentLang.micClickToActivate;
                        this.transcription.textContent = this.currentLang.transcriptionPlaceholder;
                        break;
                    
                    case 'INITIALIZING':
                        this.micBtn.classList.add('active');
                        this.micStatus.textContent = this.currentLang.micInitializing;
                        this.micStatus.classList.add('processing');
                        this.transcription.textContent = 'Initializing voice recognition...';
                        break;
                    
                    case 'ACTIVE':
                        this.micBtn.classList.add('active');
                        if (this.isPlayingAudio) {
                            this.micBtn.classList.add('speaking');
                            this.micStatus.textContent = this.currentLang.micSpeaking;
                            this.micStatus.classList.add('speaking');
                        } else {
                            this.micBtn.classList.remove('speaking');
                            this.micStatus.textContent = this.currentLang.micActive;
                            this.micStatus.classList.add('listening');
                        }
                        break;
                    
                    case 'ERROR':
                        this.micStatus.textContent = this.currentLang.micError;
                        this.micStatus.classList.add('error');
                        this.transcription.textContent = 'An error occurred. Click the microphone to try again.';
                        break;
                    
                    case 'DISABLED':
                        this.micStatus.textContent = this.currentLang.micDisabled;
                        this.micStatus.classList.add('error');
                        this.transcription.textContent = 'Microphone disabled. Reload the page to try again.';
                        break;
                }

                // Update global status bar
                if (this.isApiConfigured) {
                    this.statusBar.textContent = this.currentLang.statusReady + ' (API)';
                    this.statusBar.className = 'status-bar connected';
                } else {
                    this.statusBar.textContent = this.currentLang.statusDemo;
                    this.statusBar.className = 'status-bar';
                }
            }

            // === ERROR MANAGEMENT ===

            incrementErrorCount() {
                const now = Date.now();
                
                if (now - this.lastErrorTime > this.errorResetInterval) {
                    this.errorCount = 0;
                }
                
                this.errorCount++;
                this.lastErrorTime = now;
                
                console.log(`📊 Error count: ${this.errorCount}/${this.maxErrors}`);
            }

            resetErrorCount() {
                this.errorCount = 0;
                this.lastErrorTime = 0;
                console.log('✅ Error count reset');
            }

            // === AUDIO ELEVENLABS ===

            initAudioControls() {
                this.updateAudioControls();
                console.log('🔊 ElevenLabs audio controls initialized');
            }

            updateAudioControls() {
                if (this.audioToggle) {
                    this.audioToggle.textContent = this.audioEnabled ? '🔊' : '🔇';
                    this.audioToggle.className = `audio-control-btn ${this.audioEnabled ? 'active' : 'muted'}`;
                    this.audioToggle.title = this.audioEnabled ? 'Disable audio' : 'Enable audio';
                }
                
                if (this.volumeControl) {
                    const volumeLevel = this.audioVolume > 0.7 ? '🔊' : this.audioVolume > 0.3 ? '🔉' : '🔈';
                    this.volumeControl.textContent = volumeLevel;
                }
            }

            toggleAudio() {
                this.audioEnabled = !this.audioEnabled;
                localStorage.setItem('aluia_audio_enabled', this.audioEnabled.toString());
                this.updateAudioControls();
                
                if (!this.audioEnabled && this.currentAudio) {
                    this.stopCurrentAudio();
                }
                
                this.showToast(this.audioEnabled ? 'Audio enabled' : 'Audio disabled', 'success');
                console.log('🔊 Audio toggled:', this.audioEnabled);
            }

            cycleVolume() {
                const volumes = [0.2, 0.5, 0.8, 1.0];
                const currentIndex = volumes.findIndex(v => Math.abs(v - this.audioVolume) < 0.1);
                const nextIndex = (currentIndex + 1) % volumes.length;
                
                this.audioVolume = volumes[nextIndex];
                localStorage.setItem('aluia_audio_volume', this.audioVolume.toString());
                this.updateAudioControls();
                
                if (this.currentAudio) {
                    this.currentAudio.volume = this.audioVolume;
                }
                
                this.showToast(`Volume: ${Math.round(this.audioVolume * 100)}%`, 'success');
                console.log('🎚️ Volume changed:', this.audioVolume);
            }

            stopCurrentAudio() {
                if (this.currentAudio) {
                    this.currentAudio.pause();
                    this.currentAudio.currentTime = 0;
                    this.currentAudio = null;
                    this.isPlayingAudio = false;
                    
                    this.updateUI();
                    console.log('🔇 Audio stopped');
                }
            }

            async speakText(text) {
                if (!this.audioEnabled || !text.trim()) {
                    console.log('🔇 Audio disabled or empty text');
                    return;
                }

                this.stopCurrentAudio();

                try {
                    console.log('🗣️ Attempting ElevenLabs audio synthesis...');
                    
                    this.isPlayingAudio = true;
                    this.updateUI();
                    
                    const response = await fetch('/api/elevenlabs-tts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            voice_id: this.elevenLabsVoiceId
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 404) {
                            console.log('⚠️ ElevenLabs endpoint not configured, disabling audio');
                            this.audioEnabled = false;
                            localStorage.setItem('aluia_audio_enabled', 'false');
                            this.updateAudioControls();
                            throw new Error('Audio endpoint not configured');
                        }
                        throw new Error(`ElevenLabs API error: ${response.status}`);
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    this.currentAudio = new Audio(audioUrl);
                    this.currentAudio.volume = this.audioVolume;

                    this.currentAudio.onended = () => {
                        console.log('✅ Audio completed');
                        this.isPlayingAudio = false;
                        this.updateUI();
                        
                        if (this.micState === 'ACTIVE') {
                            this.restartRecognition();
                        }
                        
                        URL.revokeObjectURL(audioUrl);
                        this.currentAudio = null;
                    };

                    this.currentAudio.onerror = (error) => {
                        console.error('❌ Audio playback error:', error);
                        this.isPlayingAudio = false;
                        this.updateUI();
                        URL.revokeObjectURL(audioUrl);
                        this.currentAudio = null;
                    };

                    await this.currentAudio.play();
                    console.log('🔊 Audio played successfully');

                } catch (error) {
                    console.error('❌ Audio synthesis error:', error);
                    this.isPlayingAudio = false;
                    this.updateUI();
                    
                    if (!error.message.includes('not configured')) {
                        this.showToast('Temporary audio error', 'warning');
                    }
                }
            }

            // === VOICE PROCESSING ===

            async processVoiceInput(text) {
                if (this.isProcessing || !text.trim()) return;
                
                console.log('🗣️ Processing voice input:', text);
                this.isProcessing = true;
                
                if (this.recognition && this.micState === 'ACTIVE') {
                    try {
                        this.recognition.stop();
                    } catch (e) {
                        console.warn('⚠️ Error stopping recognition for processing:', e);
                    }
                }
                
                try {
                    this.addMessage('user', text);
                    await this.sendToAssistant(text);
                } catch (error) {
                    console.error('❌ Voice processing error:', error);
                    this.showToast('Voice message processing error', 'error');
                } finally {
                    this.isProcessing = false;
                }
            }

            // === CHAT ===

            sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message) return;

                console.log('💬 Sending message:', message);
                this.chatInput.value = '';
                this.addMessage('user', message);
                this.sendToAssistant(message);
            }

            async sendToAssistant(message) {
                this.showTyping();
                
                try {
                    if (this.isApiConfigured) {
                        console.log('🔑 Attempting with OpenAI API...');
                        
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-3.5-turbo',
                                messages: [
                                    {
                                        role: 'system',
                                        content: this.currentLang.systemPrompt
                                    },
                                    ...this.conversationHistory,
                                    { role: 'user', content: message }
                                ],
                                temperature: 0.7,
                                max_tokens: 500
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API error: ${response.status}`);
                        }

                        const data = await response.json();
                        const reply = data.choices[0].message.content;

                        console.log('✅ OpenAI response received');
                        this.hideTyping();
                        this.addMessage('assistant', reply);
                        
                        if (this.audioEnabled) {
                            await this.speakText(reply);
                        }
                        
                        this.conversationHistory.push(
                            { role: 'user', content: message },
                            { role: 'assistant', content: reply }
                        );
                        
                        if (this.conversationHistory.length > 20) {
                            this.conversationHistory = this.conversationHistory.slice(-20);
                        }
                        return;
                    }
                } catch (error) {
                    console.log('⚠️ API not available:', error.message);
                    this.showToast('API connection error: demo mode activated', 'warning');
                }
                
                // Demo mode
                this.hideTyping();
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                
                const demoReply = this.getDemoResponse(message);
                this.addMessage('assistant', demoReply);
                
                if (this.audioEnabled) {
                    await this.speakText(demoReply);
                }
                
                console.log('💡 Demo response sent');
            }

            getDemoResponse(message) {
                const msg = message.toLowerCase();
                
                // Universal responses that work in all languages
                if (msg.includes('harm') || msg.includes('suicid') || msg.includes('die') ||
                    msg.includes('farmi male') || msg.includes('suicid') || msg.includes('morire') ||
                    msg.includes('mal') || msg.includes('dano') || msg.includes('morir')) {
                    return '💙 I am deeply concerned about what you are experiencing. Please, do not stay alone with these thoughts. There are people ready to help you IMMEDIATELY. Check the emergency contacts below. Your life has value. Let\'s talk about it together, I\'m here for you.';
                } else if (msg.includes('anxiet') || msg.includes('panic') || msg.includes('fear') ||
                          msg.includes('ansia') || msg.includes('paura') || msg.includes('miedo')) {
                    return '😌 I understand that anxiety can be overwhelming. Let\'s try a breathing technique:\n\n1. Inhale for 4 seconds\n2. Hold for 4 seconds\n3. Exhale for 6 seconds\n4. Repeat 5 times\n\nWhat worries you most right now?';
                } else if (msg.includes('depress') || msg.includes('sad') || msg.includes('alone') ||
                          msg.includes('triste') || msg.includes('solo') || msg.includes('sola')) {
                    return '💙 I\'m sorry you feel this way. Depression is difficult, but you\'re not alone. Every small step counts. Have you thought about talking to someone you trust?';
                } else if (msg.includes('hello') || msg.includes('hi') || msg.includes('good') ||
                          msg.includes('ciao') || msg.includes('salve') || msg.includes('buon') ||
                          msg.includes('ola') || msg.includes('bom') || msg.includes('hola')) {
                    return '👋 Hello! I\'m Alu and I\'m happy you\'re here. How do you feel today? I\'m here to listen to you without judgment.';
                } else if (msg.includes('thank') || msg.includes('grazie') || msg.includes('obrigad') || msg.includes('gracias')) {
                    return '😊 You\'re welcome! It\'s an honor to support you. Remember that asking for help is courage. How do you feel now?';
                } else {
                    return '🤗 I listen to you carefully. What you feel is important. Do you want to tell me more? Remember: every day is a new beginning. 💙';
                }
            }

            addMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = content;
                
                this.chatContainer.appendChild(messageDiv);
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                
                if ('vibrate' in navigator && type === 'assistant') {
                    navigator.vibrate(50);
                }
            }

            showTyping() {
                this.typingIndicator.style.display = 'flex';
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            hideTyping() {
                this.typingIndicator.style.display = 'none';
            }

            // === ADMIN ===

            showAdminModal() {
                document.getElementById('apiKey').value = '';
                document.getElementById('assistantId').value = '';
                this.adminModal.style.display = 'block';
            }

            hideAdminModal() {
                this.adminModal.style.display = 'none';
            }

            saveAdminConfig() {
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (!apiKey) {
                    this.showToast('API Key required', 'error');
                    return;
                }
                
                if (!apiKey.startsWith('sk-')) {
                    this.showToast('Invalid API Key (must start with sk-)', 'error');
                    return;
                }
                
                this.apiKey = apiKey;
                localStorage.setItem('aluia_api_key', this.apiKey);
                this.isApiConfigured = true;
                
                this.updateUI();
                this.hideAdminModal();
                this.showToast('Configuration saved! OpenAI API activated.', 'success');
                console.log('✅ API configured');
            }

            // === THEME ===

            toggleTheme() {
                this.isDarkMode = !this.isDarkMode;
                localStorage.setItem('aluia_theme', this.isDarkMode ? 'dark' : 'light');
                this.applyTheme();
                this.showToast(`${this.isDarkMode ? 'Dark' : 'Light'} theme activated`, 'success');
            }

            applyTheme() {
                if (this.isDarkMode) {
                    document.body.classList.add('dark-mode');
                    this.themeToggle.textContent = '☀️';
                } else {
                    document.body.classList.remove('dark-mode');
                    this.themeToggle.textContent = '🌙';
                }
            }

            // === UTILITY ===

            showPrivacyInfo() {
                this.showToast('All conversations are private and secure. Data is not saved.', 'success');
            }

            clearTimeouts() {
                if (this.stateTimeout) {
                    clearTimeout(this.stateTimeout);
                    this.stateTimeout = null;
                }
            }

            startHealthCheck() {
                this.healthCheckInterval = setInterval(() => {
                    this.performHealthCheck();
                }, 30000);
            }

            performHealthCheck() {
                if (this.micState === 'ACTIVE' && this.recognition) {
                    console.log('🏥 Health check - microphone OK');
                }
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
            }

            // === CLEANUP ===

            destroy() {
                console.log('🧹 Cleaning up AluIA...');
                
                this.clearTimeouts();
                
                if (this.healthCheckInterval) {
                    clearInterval(this.healthCheckInterval);
                }
                
                if (this.recognition) {
                    try {
                        this.recognition.stop();
                        this.recognition.abort();
                    } catch (e) {}
                }
                
                if (this.currentAudio) {
                    this.currentAudio.pause();
                }
            }
        }

        // === INITIALIZATION ===

        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM loaded, initializing AluIA Multilingual...');
            window.aluia = new AluIA();
        });

        window.addEventListener('beforeunload', () => {
            if (window.aluia) {
                window.aluia.destroy();
            }
        });

        // === DEBUG FUNCTIONS ===

        window.micStatus = () => {
            if (window.aluia) {
                console.log('🔍 Microphone state:', window.aluia.micState);
                console.log('🔍 Errors:', window.aluia.errorCount);
                console.log('🔍 Audio enabled:', window.aluia.audioEnabled);
                console.log('🔍 Audio playing:', window.aluia.isPlayingAudio);
                console.log('🔍 API configured:', window.aluia.isApiConfigured);
                console.log('🔍 Language:', window.aluia.detectedLanguage);
                console.log('🔍 Selected device:', window.aluia.selectedDeviceId);
                console.log('🔍 Device type:', window.aluia.deviceType);
                console.log('🔍 Available devices:', window.aluia.availableDevices.length);
            }
        };

        window.resetMic = () => {
            if (window.aluia) {
                window.aluia.stopMicrophone();
                window.aluia.resetErrorCount();
                window.aluia.showToast('Microphone reset', 'success');
            }
        };

        window.testAudio = () => {
            if (window.aluia) {
                window.aluia.speakText('Test audio from AluIA. How are you?');
            }
        };

        window.testVoice = () => {
            if (window.aluia) {
                window.aluia.processVoiceInput('This is a voice transcription test');
            }
        };

        window.switchLanguage = (lang) => {
            if (window.aluia && translations[lang]) {
                const url = new URL(window.location);
                url.searchParams.set('lang', lang);
                window.location.href = url.toString();
            }
        };

        window.listDevices = () => {
            if (window.aluia) {
                console.log('🎤 Available microphone devices:');
                window.aluia.availableDevices.forEach((device, index) => {
                    const selected = device.deviceId === window.aluia.selectedDeviceId ? ' ← SELECTED' : '';
                    const type = window.aluia.classifyDevice(device.label);
                    console.log(`${index + 1}. [${type.toUpperCase()}] ${device.label}${selected}`);
                });
            }
        };

        console.log('✅ AluIA Multilingual + Smart Microphone loaded');
        console.log('🌍 Available languages: it, en, pt, es');
        console.log('Debug commands: micStatus(), resetMic(), testAudio(), testVoice(), listDevices(), switchLanguage(lang)');
    </script>
</body>
</html>
